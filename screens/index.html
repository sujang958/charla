<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/app.css" />
    <title>Charla</title>
  </head>
  <body>
    <p id="loading-text">&lt;omom1972&gt;: 로딩중...</p>

    <script>
      const { ipcRenderer } = require("electron")
      const { Client } = require("tmi.js")

      let client = null

      const getChannel = async (token) => {
        const headers = new Headers()
        headers.append("Authorization", `OAuth ${token}`)

        const res = await fetch("https://id.twitch.tv/oauth2/validate", {
          headers,
        })
        const data = await res.json()

        return data.login
      }

      const storeUser = ({ token, channel }) => {
        storeToken(token)
        storeChannel(channel)
      }

      const storeToken = (token) => localStorage.setItem("token", token)
      const storeChannel = (channel) => localStorage.setItem("channel", channel)

      const refreshUser = async () => {
        const token = await ipcRenderer.invoke("sign-in")
        const channel = await getChannel(token)
        storeUser({ token, channel })
      }

      const validateStoredUser = async () => {
        const token = localStorage.getItem("token")
        const headers = new Headers()
        headers.append("Authorization", `OAuth ${token}`)

        const res = await fetch("https://id.twitch.tv/oauth2/validate", {
          headers,
        })
        const data = await res.json()

        if ("message" in data) return false

        return true
      }

      const init = async () => {
        if (!(await validateStoredUser())) await refreshUser()

        const token = localStorage.getItem("token")
        const channel = localStorage.getItem("channel")

        client = new Client({
          channels: [channel],
          identity: {
            username: "Charla",
            password: token,
          },
        })

        client.on("connected", () => console.log("Connected to Twitch"))

        client.on("message", (_, user, message) => {
          appendMessage({ id: user.username, message })
        })

        client.connect()
      }

      const appendMessage = ({ id, message }) => {
        const p = document.createElement("p")
        p.innerText = `<${id}>: ${message}`

        document.body.appendChild(p)
        window.scrollTo(0, document.body.scrollHeight)
      }

      const removeLoadingText = () => {
        document.getElementById("loading-text").style.display = "none"
      }

      const cleanUpTexts = () => {
        document.querySelectorAll("p").forEach((element) => {
          element.remove()
        })
      }

      const main = async () => {
        await init()
        removeLoadingText()

        setInterval(cleanUpTexts, 1000 * 60 * 5)
      }

      main()
    </script>
  </body>
</html>
